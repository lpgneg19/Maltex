name: Build and Release macOS App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build and Release
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          brew install xcodegen
          brew install create-dmg

      - name: Generate Project
        run: xcodegen

      - name: Create ExportOptions.plist
        run: |
          cat <<EOF > ExportOptions.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>developer-id</string>
              <key>signingStyle</key>
              <string>manual</string>
          </dict>
          </plist>
          EOF

      - name: Build Universal App
        run: |
          xcodebuild build \
            -scheme AppleSword \
            -destination "platform=macOS" \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            BUILD_DIR=Build

      - name: Prepare Universal App
        run: |
          mkdir -p Build/Universal
          cp -R Build/Release/AppleSword.app Build/Universal/
          # Ad-hoc sign the app to ensure system features like vibrancy work correctly
          codesign --force --deep --sign - Build/Universal/AppleSword.app

      - name: Split Architectures (x86_64 & arm64)
        run: |
          mkdir -p Build/x86_64/AppleSword.app
          mkdir -p Build/arm64/AppleSword.app
          
          # Copy Universal app to specific folders
          cp -R Build/Universal/AppleSword.app/ Build/x86_64/AppleSword.app/
          cp -R Build/Universal/AppleSword.app/ Build/arm64/AppleSword.app/
          
          # Thin main executable
          lipo -thin x86_64 Build/Universal/AppleSword.app/Contents/MacOS/AppleSword -output Build/x86_64/AppleSword.app/Contents/MacOS/AppleSword
          lipo -thin arm64 Build/Universal/AppleSword.app/Contents/MacOS/AppleSword -output Build/arm64/AppleSword.app/Contents/MacOS/AppleSword
          
          # Thin Safari Extension
          lipo -thin x86_64 "Build/Universal/AppleSword.app/Contents/PlugIns/AppleSword Extension.appex/Contents/MacOS/AppleSword Extension" -output "Build/x86_64/AppleSword.app/Contents/PlugIns/AppleSword Extension.appex/Contents/MacOS/AppleSword Extension"
          lipo -thin arm64 "Build/Universal/AppleSword.app/Contents/PlugIns/AppleSword Extension.appex/Contents/MacOS/AppleSword Extension" -output "Build/arm64/AppleSword.app/Contents/PlugIns/AppleSword Extension.appex/Contents/MacOS/AppleSword Extension"

          # Re-sign thinned apps
          codesign --force --deep --sign - Build/x86_64/AppleSword.app
          codesign --force --deep --sign - Build/arm64/AppleSword.app
          
          echo "Verifying Architectures:"
          file Build/Universal/AppleSword.app/Contents/MacOS/AppleSword
          file Build/x86_64/AppleSword.app/Contents/MacOS/AppleSword
          file Build/arm64/AppleSword.app/Contents/MacOS/AppleSword

      - name: Create DMGs
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          
          # Universal
          create-dmg \
            --volname "AppleSword Installer" \
            --volicon "AppleSword/Assets.xcassets/AppIcon.appiconset/icon.png" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "AppleSword.app" 200 190 \
            --hide-extension "AppleSword.app" \
            --app-drop-link 600 185 \
            "AppleSword-${VERSION}-Universal.dmg" \
            "Build/Universal/AppleSword.app"

          # x86_64
          create-dmg \
            --volname "AppleSword Installer (Intel)" \
            --volicon "AppleSword/Assets.xcassets/AppIcon.appiconset/icon.png" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "AppleSword.app" 200 190 \
            --hide-extension "AppleSword.app" \
            --app-drop-link 600 185 \
            "AppleSword-${VERSION}-x86_64.dmg" \
            "Build/x86_64/AppleSword.app"

          # arm64
          create-dmg \
            --volname "AppleSword Installer (Apple Silicon)" \
            --volicon "AppleSword/Assets.xcassets/AppIcon.appiconset/icon.png" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "AppleSword.app" 200 190 \
            --hide-extension "AppleSword.app" \
            --app-drop-link 600 185 \
            "AppleSword-${VERSION}-arm64.dmg" \
            "Build/arm64/AppleSword.app"

      - name: Extract Release Notes
        id: extract_release_notes
        run: |
          # Extract the content of the latest version from CHANGELOG.md
          # This skips the first header and stops before the next header
          RELEASE_NOTES=$(awk '/^## \[/{if (count++) exit; next} count' CHANGELOG.md)
          
          # Handle multi-line output for GitHub Actions environment variables
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          body: ${{ steps.extract_release_notes.outputs.notes }}
          files: |
            AppleSword-*-Universal.dmg
            AppleSword-*-x86_64.dmg
            AppleSword-*-arm64.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
