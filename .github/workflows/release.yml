name: Build and Release macOS App

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build and Release
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          brew install xcodegen
          brew install create-dmg

      - name: Generate Project
        run: xcodegen

      - name: Create ExportOptions.plist
        run: |
          cat <<EOF > ExportOptions.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>developer-id</string>
              <key>signingStyle</key>
              <string>manual</string>
          </dict>
          </plist>
          EOF

      - name: Build Universal Archive
        run: |
          xcodebuild archive \
            -scheme AppleSword \
            -destination "generic/platform=macOS" \
            -archivePath AppleSword.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Export Universal App
        run: |
          # Exporting manually to avoid signing issues in CI without certs
          mkdir -p Build/Universal/AppleSword.app
          cp -R AppleSword.xcarchive/Products/Applications/AppleSword.app/ Build/Universal/AppleSword.app/

      - name: Split Architectures (x86_64 & arm64)
        run: |
          mkdir -p Build/x86_64/AppleSword.app
          mkdir -p Build/arm64/AppleSword.app
          
          # Copy Universal app to specific folders
          cp -R Build/Universal/AppleSword.app/ Build/x86_64/AppleSword.app/
          cp -R Build/Universal/AppleSword.app/ Build/arm64/AppleSword.app/
          
          # Strip to x86_64
          lipo -thin x86_64 Build/Universal/AppleSword.app/Contents/MacOS/AppleSword -output Build/x86_64/AppleSword.app/Contents/MacOS/AppleSword
          
          # Strip to arm64
          lipo -thin arm64 Build/Universal/AppleSword.app/Contents/MacOS/AppleSword -output Build/arm64/AppleSword.app/Contents/MacOS/AppleSword
          
          echo "Verifying Architectures:"
          file Build/Universal/AppleSword.app/Contents/MacOS/AppleSword
          file Build/x86_64/AppleSword.app/Contents/MacOS/AppleSword
          file Build/arm64/AppleSword.app/Contents/MacOS/AppleSword

      - name: Create DMGs
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          
          # Universal
          create-dmg \
            --volname "AppleSword Installer" \
            --volicon "AppleSword/Assets.xcassets/AppIcon.appiconset/icon.png" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "AppleSword.app" 200 190 \
            --hide-extension "AppleSword.app" \
            --app-drop-link 600 185 \
            "AppleSword-${VERSION}-Universal.dmg" \
            "Build/Universal/AppleSword.app"

          # x86_64
          create-dmg \
            --volname "AppleSword Installer (Intel)" \
            --volicon "AppleSword/Assets.xcassets/AppIcon.appiconset/icon.png" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "AppleSword.app" 200 190 \
            --hide-extension "AppleSword.app" \
            --app-drop-link 600 185 \
            "AppleSword-${VERSION}-x86_64.dmg" \
            "Build/x86_64/AppleSword.app"

          # arm64
          create-dmg \
            --volname "AppleSword Installer (Apple Silicon)" \
            --volicon "AppleSword/Assets.xcassets/AppIcon.appiconset/icon.png" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "AppleSword.app" 200 190 \
            --hide-extension "AppleSword.app" \
            --app-drop-link 600 185 \
            "AppleSword-${VERSION}-arm64.dmg" \
            "Build/arm64/AppleSword.app"

      - name: Build Changelog
        id: build_changelog
        uses: mikepenz/release-changelog-builder-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          body: ${{ steps.build_changelog.outputs.changelog }}
          files: |
            AppleSword-*-Universal.dmg
            AppleSword-*-x86_64.dmg
            AppleSword-*-arm64.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
