name: Build and Release macOS App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build and Release
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          brew install xcodegen
          brew install create-dmg

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Check Xcode Version
        run: xcodebuild -version

      - name: Generate Project
        run: xcodegen

      - name: Resolve Package Dependencies
        run: xcodebuild -resolvePackageDependencies -scheme Maltex

      - name: Build Universal App
        run: |
          xcodebuild build \
            -scheme Maltex \
            -destination "platform=macOS" \
            -configuration Release \
            -derivedDataPath ./DerivedData \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEBUG_INFORMATION_FORMAT=dwarf \
            ENABLE_APP_INTENTS_METADATA_EXTRACTION=NO \
            ONLY_ACTIVE_ARCH=NO \
            MACOSX_DEPLOYMENT_TARGET=15.0 \
            SWIFT_STRICT_CONCURRENCY=minimal \
            COMPILER_INDEX_STORE_ENABLE=NO \
            -skipPackageUpdates

      - name: Prepare Universal App
        run: |
          mkdir -p Build/Universal
          cp -R ./DerivedData/Build/Products/Release/Maltex.app Build/Universal/
          # Ad-hoc sign the app with Hardened Runtime options to ensure system features work correctly
          codesign --force --deep --sign - --options=runtime Build/Universal/Maltex.app

      - name: Split Architectures (x86_64 & arm64)
        run: |
          mkdir -p Build/x86_64/Maltex.app
          mkdir -p Build/arm64/Maltex.app
          
          # Copy Universal app to specific folders
          cp -R Build/Universal/Maltex.app/ Build/x86_64/Maltex.app/
          cp -R Build/Universal/Maltex.app/ Build/arm64/Maltex.app/
          
          # Thin main executable
          lipo -thin x86_64 Build/Universal/Maltex.app/Contents/MacOS/Maltex -output Build/x86_64/Maltex.app/Contents/MacOS/Maltex
          lipo -thin arm64 Build/Universal/Maltex.app/Contents/MacOS/Maltex -output Build/arm64/Maltex.app/Contents/MacOS/Maltex
          
          # Thin Safari Extension
          lipo -thin x86_64 "Build/Universal/Maltex.app/Contents/PlugIns/Maltex Extension.appex/Contents/MacOS/Maltex Extension" -output "Build/x86_64/Maltex.app/Contents/PlugIns/Maltex Extension.appex/Contents/MacOS/Maltex Extension"
          lipo -thin arm64 "Build/Universal/Maltex.app/Contents/PlugIns/Maltex Extension.appex/Contents/MacOS/Maltex Extension" -output "Build/arm64/Maltex.app/Contents/PlugIns/Maltex Extension.appex/Contents/MacOS/Maltex Extension"

          # Re-sign thinned apps deeply with runtime options
          codesign --force --deep --sign - --options=runtime Build/x86_64/Maltex.app
          codesign --force --deep --sign - --options=runtime Build/arm64/Maltex.app
          
          echo "Verifying Architectures:"
          file Build/Universal/Maltex.app/Contents/MacOS/Maltex
          file Build/x86_64/Maltex.app/Contents/MacOS/Maltex
          file Build/arm64/Maltex.app/Contents/MacOS/Maltex

      - name: Create DMGs
        id: create_dmgs
        run: |
          # Safe version extraction
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="manual-$(date +%Y%m%d%H%M%S)"
          fi
          # Sanitize: replace / with - to avoid path issues
          VERSION=${VERSION//\//-}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Universal
          create-dmg \
            --volname "Maltex Installer" \
            --volicon "Maltex/Assets.xcassets/AppIcon.appiconset/icon.png" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "Maltex.app" 200 190 \
            --hide-extension "Maltex.app" \
            --app-drop-link 600 185 \
            "Maltex-${VERSION}-Universal.dmg" \
            "Build/Universal/Maltex.app"

          # x86_64
          create-dmg \
            --volname "Maltex Installer (Intel)" \
            --volicon "Maltex/Assets.xcassets/AppIcon.appiconset/icon.png" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "Maltex.app" 200 190 \
            --hide-extension "Maltex.app" \
            --app-drop-link 600 185 \
            "Maltex-${VERSION}-x86_64.dmg" \
            "Build/x86_64/Maltex.app"

          # arm64
          create-dmg \
            --volname "Maltex Installer (Apple Silicon)" \
            --volicon "Maltex/Assets.xcassets/AppIcon.appiconset/icon.png" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "Maltex.app" 200 190 \
            --hide-extension "Maltex.app" \
            --app-drop-link 600 185 \
            "Maltex-${VERSION}-arm64.dmg" \
            "Build/arm64/Maltex.app"

      - name: Extract Release Notes
        id: extract_release_notes
        run: |
          # Extract the content of the latest version from CHANGELOG.md
          RELEASE_NOTES=$(awk '/^## \[/{if (count++) exit; next} count' CHANGELOG.md || echo "Manual build from branch $GITHUB_REF")
          
          # Handle empty notes
          if [ -z "$RELEASE_NOTES" ]; then
            RELEASE_NOTES="Manual build from branch $GITHUB_REF"
          fi

          # Handle multi-line output for GitHub Actions environment variables
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          draft: ${{ github.event_name == 'workflow_dispatch' }}
          body: ${{ steps.extract_release_notes.outputs.notes }}
          files: |
            Maltex-*-Universal.dmg
            Maltex-*-x86_64.dmg
            Maltex-*-arm64.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
